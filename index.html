<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>Jadwal Shalat</title>
	<link rel="stylesheet" href="www/public/css/normalize.min.css" />
	<link rel="stylesheet" href="www/public/js/owlcarousel/assets/owl.carousel.min.css" />
	<link rel="stylesheet" href="www/public/js/owlcarousel/assets/owl.theme.default.min.css" />
	<link rel="stylesheet" href="www/public/css/styles.css" />
</head>

<body>
	<div class="mycontainer p-0">
		<div class="row first">
			<div class="col col4">
				<div class="time mybox"></div>
				<div class="countdown-event mybox"></div>
			</div>
			<div class="col col2 text-center">
				<div class="middle1"></div>
				<div class="middle2"></div>
				<div class="middle3">
					TZ: <span class="tz-offset"></span> |
					LAT: <span class="latitude"></span> |
					LNG: <span class="longitude"></span> |
					ALT: <span class="altitude"></span>
				</div>
			</div>
			<div class="col col4">
				<div class="day mybox"></div>
				<div class="date mybox"></div>
			</div>
			<div class="clear"></div>
		</div>
		<div class="row super-block">
			<div class="row second">
				<div class="second-block">
					<div class="col7 myprayer">
						<div class="prayer-title">IMSAK</div>
						<div class="prayer-time IMSAK"></div>
					</div>
					<div class="col7 myprayer">
						<div class="prayer-title">SUBUH</div>
						<div class="prayer-time SUBUH"></div>
					</div>
					<div class="col7 myprayer">
						<div class="prayer-title">SYURUQ</div>
						<div class="prayer-time SYURUQ"></div>
					</div>
					<div class="col7 myprayer">
						<div class="prayer-title">ZHUHUR</div>
						<div class="prayer-time ZHUHUR"></div>
					</div>
					<div class="col7 myprayer">
						<div class="prayer-title">ASHAR</div>
						<div class="prayer-time ASHAR"></div>
					</div>
					<div class="col7 myprayer">
						<div class="prayer-title">MAGHRIB</div>
						<div class="prayer-time MAGHRIB"></div>
					</div>
					<div class="col7 myprayer">
						<div class="prayer-title">ISYA</div>
						<div class="prayer-time ISYA"></div>
					</div>
					<div class="clear"></div>
				</div>
			</div>

			<div class="row third">
				<div class="wallpaper">
					<div class="slide-container owl-carousel owl-theme">
					</div>
					<div class="running-container">
						<div class="running-text"></div>
						<div id="fullscreen-button" onclick="toggle_fullscreen()">
							<svg viewBox="0 0 24 24">
								<path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 
								7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z" />
							</svg>
							<svg viewBox="0 0 24 24">
								<path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 
								11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z" />
							</svg>
						</div>
					</div>
				</div>

				<div class="row four">
					<div class="row">
						<div class="footer1">Versi : <span class="version"></span></div>
						<div class="footer2 appname">Nama Aplikasi</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="layer"></div>

	<!--fix problem : google chrome update will not autoplay audio/video-->
	<iframe src="www/public/audio/silence.mp3" allow="autoplay" id="audio" style="display:none"></iframe>
	<audio id="player">
		<source src="www/public/audio/beep.mp3" type="audio/mp3">
	</audio>

	<script src="www/public/js/jquery-3.3.1.min.js"></script>
	<script src="www/public/js/moment-with-locales.min.js"></script>
	<script src="www/public/js/moment-hijri.js"></script>

	<script src="www/public/js/PrayTimes.js"></script>
	<script src="www/public/js/jquery.marquee.min.js"></script>


	<script type="module">
		import { ref, listAll, getDownloadURL, storage } from './www/config/firebase.js'
		import { app, setting } from './www/config/appconfig.js'
		//app setting
		if (app.autoLocation) {
			if ("geolocation" in navigator) { //check Geolocation available 
				navigator.geolocation.getCurrentPosition(function (position) {
					setting.latitude = position.coords.latitude;
					setting.longitude = position.coords.longitude;
					setting.altitude = position.coords.altitude !== null ? position.coords.altitude : setting.altitude;
					setting.timezone = moment().utcOffset() / 60;
				},
					function error(msg) {
						//do nothing
					},
					{ maximumAge: 10000, timeout: 5000, enableHighAccuracy: true });
			} else {
				//console.log("Geolocation not available!");
			}
		}
		
		let finalTime;

		let offsetIcon = setting.timezoneOffset > 0 ? '+' : (setting.timezoneOffset == 0) ? '' : '-';
		let now = new Date(); // today
		prayTimes.setMethod(setting.methodCalc);
		prayTimes.tune(setting.tune);
		let times = prayTimes.getTimes(now, [setting.latitude, setting.longitude], setting.timezoneOffset, setting.dst);
		let masterTime = [times.imsak, times.fajr, times.sunrise, times.dhuhr, times.asr, times.maghrib, times.isha];
		let masterName = setting.aliasName;
		let tempShalat = masterTime;
		$('.IMSAK').text(times.imsak);
		$('.SUBUH').text(times.fajr);
		$('.SYURUQ').text(times.sunrise);
		$('.ZHUHUR').text(times.dhuhr);
		$('.ASHAR').text(times.asr);
		$('.MAGHRIB').text(times.maghrib);
		$('.ISYA').text(times.isha);
		//console.log(times);			
		$('.tz-offset').text(offsetIcon + setting.timezoneOffset);
		$('.latitude').text(setting.latitude);
		$('.longitude').text(setting.longitude);
		$('.altitude').text(setting.altitude);
		$('.middle1').text(setting.nama);
		$('.middle2').text(setting.alamat);
		$('.version').text(app.version);
		$('.appname').text(app.name);

		$.ajax({
			url: setting.runningTextFile,
			success: function (d) {
				$('.running-text').text(d);
				$('.running-text').marquee({ duration: setting.runningTextSpeed });
			}
		});

		moment.locale('id');

		nextSchedule();

		// Get Images from Firebase
		// await Promise.all() is used to return the result of promise array
		let images = await Promise.all(await getImages())

		images.forEach(image => {
			$('.slide-container').append(`<div class="item" style="background-image: url('${image}')""></div>`);
		})

		// for (let a = 0; a < images.length; a++) {
		// 	$('.slide-container').append(`<div class="item" style="background-image: url('${images[a]}')""></div>`);
		// }

		$('.owl-carousel').owlCarousel({
			loop: true,
			items: 1,
			dots: false,
			lazyLoad: true,
			autoplay: true,
			smartSpeed: 1000,
			autoplayTimeout: setting.slideInterval,
			slideTransition: 'swing'
		});

		function countdownShalat(time, name, desc, shalatName = '') {
			$('.myprayer').removeClass('highlight');
			$('.' + name).closest('.myprayer').addClass('highlight');
			$('.desc').text(desc);
			finalTime = time;
			let x = setInterval(function () {
				let distance = finalTime - moment().unix();
				let hours = Math.floor((distance % (60 * 60 * 24)) / (60 * 60));
				let minutes = Math.floor((distance % (60 * 60)) / 60);
				let seconds = Math.floor(distance % (60));

				if (distance < 0) {
					clearInterval(x);
					if (name == 'adzan') {
						countdownShalat(moment().add(setting.shalatSunnahTime).unix(), 'shalat_sunnah', 'IQOMAH ' + shalatName, shalatName);
						if (shalatName == 'SUBUH') { countdownShalat(moment().add(setting.shalatSunnahTimeSubuh).unix(), 'shalat_sunnah', 'MENJELANG IQOMAH ' + shalatName, shalatName); }
					} else if (name == 'shalat_sunnah') {
						beep();
						countdownShalat(moment().add(setting.iqomahTime).unix(), 'iqomah', 'IQOMAH ' + shalatName, shalatName);
					} else if (inArray(name, ['SUBUH', 'ZHUHUR', 'ASHAR', 'MAGHRIB', 'ISYA'])) {
						beep();
						countdownShalat(moment().add(setting.adzanTime).unix(), 'adzan', 'ADZAN ' + name, name);
					} else {
						nextSchedule();
					}
				} else {
					$(".countdown-event").text(desc + moment().second(seconds).minute(minutes).hour(hours).format('HH:mm:ss'));
				}
				// Mengambil waktu terkini di zona waktu WIB menggunakan WorldTimeAPI
				let currentTime = new Date();

				// Membuat format HH:mm:ss
				let formattedTime = currentTime.toLocaleTimeString('en-US', { hour12: false });
				// Menampilkan waktu yang telah diformat
				// console.log("Waktu di WIB: " + formattedTime);
				// console.log("Waktu hari ini: " + formattedTime);
				// $('.masehi').html(moment().format('HH:mm:ss'));
				$('.time').html(formattedTime);
				$('.day').html(moment().format('dddd'));
				$('.date').html(moment().format('DD MMMM YYYY <br> iD iMMMM iYYYY'));
			}, 1000);
		}

		function nextSchedule() {
			let found = false;
			for (let a = 0; a < tempShalat.length; a++) {
				let now = moment().unix();
				let next = moment(moment().format('YYYY-MM-DD [' + tempShalat[a] + ':00]'), 'YYYY-MM-DD HH:mm:ss').unix();
				if (now < next) {//console.log(moment.unix(next).format('YYYY/MM/DD HH:mm:ss'));
					countdownShalat(next, masterName[a], masterName[a] + ' -');
					found = true;
					//console.log([masterName[a], masterTime[a]]);
					return false;
				} else {
					//console.log(tempShalat);
					//console.log('lewat'+a +masterName[a]);
					//tempShalat.shift();
				}

			}
			let splt = tempShalat[0].split(':');
			next = moment().add(1, 'day').hour(splt[0]).minute(splt[1]).second(0).unix();
			if (!found) countdownShalat(next, masterName[0], masterName[0] + ' -');
		}

		async function getImages() {
			// get reference of /images/ path from firebase storage
			let listRef = ref(storage, '/images/')
			// list all content in /images/ folder
			let res = await listAll(listRef)
			// return an array where url of each item in res.items are retrieved
			return await res.items.map(async item => {
				return await getDownloadURL(ref(storage, item))
			});
		}
		
		function inArray(needle, haystack) {
			let length = haystack.length;
			for (let i = 0; i < length; i++) {
				if (haystack[i] == needle) return true;
			}
			return false;
		}
	</script>
	<script>
		function toggle_fullscreen() {
			if (!document.fullscreenElement) {
				document.body.requestFullscreen();
				document.body.setAttribute("fullscreen", "");
			} else {
				document.exitFullscreen();
				document.body.removeAttribute("fullscreen");
			}
		}

		function beep() {
			$('#player')[0].play();
		}
	</script>
	<script src="www/public/js/owlcarousel/owl.carousel.min.js"></script>
</body>

</html>